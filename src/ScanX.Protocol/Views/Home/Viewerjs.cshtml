@model List<ScanX.Core.Models.ScannerDevice>

@{
    ViewData["Title"] = "Viewerjs";
}

@section styles{
    <link href="~/lib/viewerjs/dist/viewer.min.css" rel="stylesheet" />
    <link href="~/lib/simplebar/dist/simplebar.css" rel="stylesheet" />
}

    <div class="container content">

        <div id="alert"></div>

        <div class="row">
            <div class="col-3">

                <div class="form-group">
                    <label for="">
                        Choose scanner:
                    </label>
                    <select id="select-scanner-drp" class="form-control">

                        <option value="">--- Select Scanner ---</option>

                        @foreach (var item in Model)
                        {
                            if (item.Name.Contains("fi-7"))
                            {
                                <option value="@item.DeviceId" selected>
                                    @item.Name
                                </option>
                            }
                            else
                            {
                                <option value="@item.DeviceId">
                                    @item.Name
                                </option>

                            }
                        }

                    </select>
                </div>

                <div class="form-group">
                    <label>Color Mode:</label>
                    <select class="form-control" id="drp-color-mode">
                        <option value="2">
                            Grayscale
                        </option>
                        <option value="1">
                            Color
                        </option>
                        <option value="4">
                            Black & White
                        </option>

                    </select>
                </div>

            </div>
            <div class="col-3">
                <div class="form-group">
                    <label>DPI Res:</label>
                    <select class="form-control" id="drp-dpi">
                        <option value="72">
                            72 DPI
                        </option>
                        <option value="96">
                            96 DPI
                        </option>
                        <option value="150">
                            150 DPI
                        </option>
                        <option value="300">
                            300 DPI
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-sm btn-primary" onclick="scanSingle();">
            <i class="fas fa-file"></i>
            Scan Single
        </button>

        <button type="button" class="btn btn-sm btn-primary" onclick="scanImage();">
            <i class="fas fa-print"></i>
            Scan
        </button>

        @*<div class="row">
            <div class="col-10">
                <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
                    <div class="btn-group mr-2" role="group" aria-label="First group">
                        <button type="button" class="btn btn-sm btn-primary" onclick="scanTest();">
                            Scan Test
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" onclick="scanTest();">
                            <i class="fas fa-file"></i>
                            Scan Single Image
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" onclick="scanTest();">
                            <i class="fas fa-copy"></i>
                            Scan All Images
                        </button>
                    </div>

                </div>
            </div>
        </div>*@



        <div class="row">
            <div class="col-10">
                <div style="height:750px;">
                    <img id="image-container" style="display:none;" />
                </div>
            </div>
            <div class="col-2 border" style="background-color:whitesmoke;">

                <div data-simplebar style="height:750px;">
                    <ul id="image-list" style="padding:20px;"></ul>
                </div>

            </div>
        </div>

        <br />
        <br />
    </div>


@section scripts{


    <script src="~/lib/viewerjs/dist/viewer.min.js"></script>

    <script src="~/js/signalr.min.js"></script>

    <script src="~/js/scanx.js"></script>

    <script src="~/lib/simplebar/dist/simplebar.js"></script>


    <script type="text/javascript">

        var scan = new ScanX();
        var viewer;

        $(function () {

            setupViewer();

            setupEvents();

            scan.connect();

        });

        function scanTest() {
            scan.scanTest();
        }

        function setupEvents() {

            scan.connection.on("OnError", (data) => {
                addAlert(data);
            });

            scan.connection.on("OnFinish", () => {
                
            });

            scan.connection.on("OnImageScanned", (data) => {

                var img = '<li><img class="img-fluid" src="data: image/jpeg;base64,' + data.imageBytes + '" onclick="setImageToViewer(this)"></img><p class="text-center">' + data.page + ' <br/><span style="font-size:11px">' + data.size + ' <span></p></li>';

                $("#image-list").append(img);
            });

            scan.connection.onclose(() => {


            })
        }

        function setupViewer() {

            viewer = new Viewer(document.getElementById('image-container'), {
                inline: true,
                viewed: function () {
                    
                },
                title: false,
                navbar: false,
                zoomRatio: 0.2,
                transition: false,
                toolbar: {
                    zoomIn: 4,
                    zoomOut: 4,
                    oneToOne: false,
                    reset: 4,
                    prev: false,
                    play: {
                        show: false,
                        size: 'large',
                    },
                    next: false,
                    rotateLeft: 4,
                    rotateRight: 4,
                    flipHorizontal: 4,
                    flipVertical: 4,
                }
            });
        }
        

        function setImageToViewer(data) {

            var src = $(data).attr("src");

            $("#image-list li img").each(function (i) {
                $(this).removeClass("active");
            })

            $(data).addClass("active");

            $("#image-container").attr("src", src);

            viewer.update();
            
            viewer.next();
        }

        
        function scanSingle() {

            var deviceId = $("#select-scanner-drp").val();

            var settings = {

                color: $("#drp-color-mode").val(),

                dpi: $("#drp-dpi").val(),

            }

            scan.scanSingle(deviceId, settings);
        }

        function scanImage() {

            var deviceId = $("#select-scanner-drp").val();

            var settings = {

                color: $("#drp-color-mode").val(),

                dpi: $("#drp-dpi").val(),

            }

            scan.scanMultiple(deviceId, settings);
        }

        function addAlert(data) {

            $("#alert").append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' + data.Message + '</div >');

        }

    </script>

}
